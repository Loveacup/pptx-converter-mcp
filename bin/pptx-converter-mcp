#!/opt/homebrew/bin/python3.11
"""
PPT 转 Markdown MCP 服务器
整合单人转换和批量转换功能
使用本地 Qwen3-VL-32B 模型进行图片描述
"""
import os
import sys
import json
import subprocess
from pathlib import Path
from typing import Any, Dict, List, Optional

# MCP SDK
from mcp.server.models import InitializationOptions
from mcp.server import NotificationOptions, Server
from mcp.server.stdio import stdio_server
from mcp.types import (
    Resource,
    Tool,
    TextContent,
    ImageContent,
    EmbeddedResource,
    LoggingLevel
)

# 配置
TOOLS_DIR = Path.home() / ".local" / "bin"

def run_pptx_to_md(input_path: str, output_path: Optional[str] = None) -> Dict[str, Any]:
    """运行单人转换工具"""
    cmd = [str(TOOLS_DIR / "pptx-to-md"), input_path]
    if output_path:
        cmd.append(output_path)
    
    try:
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=600,  # 10分钟超时
            encoding='utf-8'
        )
        
        return {
            "success": result.returncode == 0,
            "stdout": result.stdout,
            "stderr": result.stderr,
            "returncode": result.returncode
        }
    except subprocess.TimeoutExpired:
        return {
            "success": False,
            "stdout": "",
            "stderr": "转换超时（超过10分钟）",
            "returncode": -1
        }
    except Exception as e:
        return {
            "success": False,
            "stdout": "",
            "stderr": str(e),
            "returncode": -1
        }

def run_pptx_batch_convert(input_dir: str, output_dir: Optional[str] = None) -> Dict[str, Any]:
    """运行批量转换工具"""
    cmd = [str(TOOLS_DIR / "pptx-batch-convert"), input_dir]
    if output_dir:
        cmd.append(output_dir)
    
    try:
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=3600,  # 1小时超时（批量处理）
            encoding='utf-8'
        )
        
        return {
            "success": result.returncode == 0,
            "stdout": result.stdout,
            "stderr": result.stderr,
            "returncode": result.returncode
        }
    except subprocess.TimeoutExpired:
        return {
            "success": False,
            "stdout": "",
            "stderr": "批量转换超时（超过1小时）",
            "returncode": -1
        }
    except Exception as e:
        return {
            "success": False,
            "stdout": "",
            "stderr": str(e),
            "returncode": -1
        }

# 创建 MCP 服务器
server = Server("pptx-converter")

@server.list_tools()
async def list_tools() -> List[Tool]:
    """列出可用工具"""
    return [
        Tool(
            name="convert_single_pptx",
            description="将单个 PPT 文件转换为 Markdown，包含 AI 图片描述",
            inputSchema={
                "type": "object",
                "properties": {
                    "input_path": {
                        "type": "string",
                        "description": "PPT 文件的完整路径"
                    },
                    "output_path": {
                        "type": "string",
                        "description": "输出 Markdown 文件路径（可选，默认与输入同名）"
                    }
                },
                "required": ["input_path"]
            }
        ),
        Tool(
            name="convert_batch_pptx",
            description="批量转换目录中的所有 PPT 文件为 Markdown",
            inputSchema={
                "type": "object",
                "properties": {
                    "input_dir": {
                        "type": "string",
                        "description": "包含 PPT 文件的目录路径"
                    },
                    "output_dir": {
                        "type": "string",
                        "description": "输出目录路径（可选，默认在输入目录旁创建 Markdown 文件夹）"
                    }
                },
                "required": ["input_dir"]
            }
        )
    ]

@server.call_tool()
async def call_tool(name: str, arguments: Any) -> List[TextContent]:
    """调用工具"""
    if isinstance(arguments, str):
        arguments = json.loads(arguments)
    
    if name == "convert_single_pptx":
        input_path = arguments.get("input_path")
        output_path = arguments.get("output_path")
        
        if not input_path:
            return [TextContent(type="text", text="错误: 必须提供 input_path")]
        
        if not os.path.exists(input_path):
            return [TextContent(type="text", text=f"错误: 文件不存在: {input_path}")]
        
        result = run_pptx_to_md(input_path, output_path)
        
        if result["success"]:
            return [TextContent(
                type="text",
                text=f"✅ 转换成功!\n\n{result['stdout']}"
            )]
        else:
            return [TextContent(
                type="text",
                text=f"❌ 转换失败!\n\n{result['stderr']}"
            )]
    
    elif name == "convert_batch_pptx":
        input_dir = arguments.get("input_dir")
        output_dir = arguments.get("output_dir")
        
        if not input_dir:
            return [TextContent(type="text", text="错误: 必须提供 input_dir")]
        
        if not os.path.exists(input_dir):
            return [TextContent(type="text", text=f"错误: 目录不存在: {input_dir}")]
        
        result = run_pptx_batch_convert(input_dir, output_dir)
        
        if result["success"]:
            return [TextContent(
                type="text",
                text=f"✅ 批量转换成功!\n\n{result['stdout']}"
            )]
        else:
            return [TextContent(
                type="text",
                text=f"❌ 批量转换失败!\n\n{result['stderr']}"
            )]
    
    else:
        return [TextContent(type="text", text=f"未知工具: {name}")]

async def main():
    """主函数 - 启动 MCP 服务器"""
    async with stdio_server(server) as (read_stream, write_stream):
        await server.run(
            read_stream,
            write_stream,
            InitializationOptions(
                server_name="pptx-converter",
                server_version="1.0.0",
                capabilities=server.get_capabilities()
            )
        )

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
